<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
        <title>Moulberry's Console</title>
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?3.5.0/build/cssreset/cssreset-min.css"/>
        <style type="text/css">
            html {
                background-color: #000;
                }
            body {
                font-family: "Lucida Console";
                font-size: 13px;
                color: #0f0;
                }
            #in {
                display: block;
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100%;
                padding: 8px;
                border-color: lighter;
                border-width: 1px 0 0 0;
                background-color: #000;
                color: #0f0;
                }
        </style>
    </head>
    <body>
        <div id="out"></div>
        <input id="in" tabindex="0"/>
    </body>
	<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
    <script type="text/javascript" src="http://yui.yahooapis.com/combo?3.5.0/build/yui/yui-min.js"></script>
    <script type="text/javascript">
		//Large or unrelated functions go here
		var res = "Couldn't read"

		function getDataURL(URL)
		{
			var xhr = new XMLHttpRequest();
			xhr.open('GET', URL, true);
			
			xhr.responseType = 'arraybuffer';
			
			xhr.onload = function(e) {
				if (this.status == 200) {
					//alert(this)
					var uInt8Array = new Uint8Array(this.response);
					var i = uInt8Array.length;
					var biStr = new Array(i);
					while (i--)
					{
						biStr[i] = String.fromCharCode(uInt8Array[i]);
					}
					var data = biStr.join('');
					var base64 = window.btoa(data);
					
					res = "data:application/zip;base64,"+base64
				}
			};
			
			xhr.send();
			return res
		}
		
		function download(filename, URL) {
			var a = window.document.createElement('a');
			a.href = URL
			a.download = filename;

			// Append anchor to body.
			document.body.appendChild(a)
			a.click();

			// Remove anchor from body
			document.body.removeChild(a)
		}
		
		function getPlainText(filename)
		{
			var xml = new XMLHttpRequest();
			xml.open('GET', filename, false);
			xml.send();
			return xml.response;
		}
		
	</script>
	<script type="text/javascript">
		//YUI stuff and commands
        YUI().use("node", function(Y) {

			var invisChar = "&zwnj;"
			
			var commands = [
                {
                    id: ["help"],
                    handler: function(args) {
						sysout("Known commands: ")
						sysout("get (filename) (password) - Retrieve an encrypted file on the system")
						sysout("encrypt (filetoencrypt) (password) - Output an encrypted file to the download stream")
					}
                },

                {
                    id: ["say","echo"],
                    handler: function(args) {
						var res = ""
						for(i = 0; i < args.length; i++)
						{
							res+=args[i]+" "
						}
                        sysout(res);
                    }
                },
				
				{
                    id: ["get"],
                    handler: function(args) {
						var errType=0;
						try {
							sysout("Retrieving file...")
							errType++
							var txt = getPlainText(username + "/" + args[0]+".aes")
							sysout("Decrypting file using AES algotithm...")
							errType++
							var resDec = CryptoJS.AES.decrypt(txt, args[1]).toString(CryptoJS.enc.Latin1)
							sysout("Done")
							errType++
							download(args[0] + ".zip", resDec)
						} catch(err) {
							switch(errType){
								case 1:
									errout("Error 002: Invalid file or file is missing, sorry!")
									break;
								case 2:
									errout("Error 003: Decryption failed!")
									break;
								case 3:
									errout("Error 004: Download request failed!")
									break;
							}
						}
					}
					
                },
				
				{
                    id: ["encrypt"],
                    handler: function(args) {
						sysout("Retrieving file...")
						alert(getDataURL(args[0]))
						var dataurl = getDataURL(args[0])
						alert(dataurl)
						sysout("Encrypting file using AES algotithm...")
						var resEnc = CryptoJS.AES.encrypt(dataurl, args[1])
						sysout("Done")
						download("test.aes", resEnc)
	
					}
                },
				
				{
                    id: ["cls","clear","wipe"],
                    handler: function(args) {
						Y.one("#out").set("value","")
					}
                }
				
            ];

            function processCommand() {
                var input = Y.one("#in");
                var value = input.get("value");
                var segments = value.replace(/\s+/g, " ").split(" ");
                var command = segments[0];
                var args = segments.length > 1 ? segments.slice(1, segments.length) : [];

                input.set("value", "");
				sysout(invisChar + " > " + value)

                for (i = 0; i < commands.length; i++) {
					for(j = 0; j < commands[i].id.length; j++)
					{
						if (command == commands[i].id[j]) {
							commands[i].handler(args);
							return;
						}
                    }
                }

                errout("Error 001: Unknown Command: " + command + ", try 'help'");
            }
			
			function sysout(text) {
                var p = Y.Node.create("<p>" + text + "</p>");
                Y.one("#out").append(p);
                p.scrollIntoView();
            }
			
			function errout(text) {
                var p = Y.Node.create("<p><font color='red'>" + text + "</font></p>");
                Y.one("#out").append(p);
                p.scrollIntoView();
            }

            Y.on("domready", function(e) {
                Y.one("body").setStyle("paddingBottom", Y.one("#in").get("offsetHeight"));
                Y.one("#in").on("keydown", function(e) {
                    if (e.charCode == 13) {
                        processCommand();
                    }
                });
            });
        });
    </script>
</html>